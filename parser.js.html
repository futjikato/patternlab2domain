<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: parser.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: parser.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module patternlab2phpcr
 * @author Moritz Spindelhirn [m.spindelhirn@cashiers-check.de]
 * @namespace Parser
 */
(function(module) {
    'use strict';

    var Mustache = require('mustache'),
        extend = require('extend'),
        fs = require('fs'),
        util = require('util'),
        events = require('events');

    /**
     * Default options for the {@link Field} class.
     *
     * @memberOf Parser
     * @namespace Parser.parserFieldDefaultOptions
     *
     * @type {{}}
     */
    var parserFieldDefaultOptions = {

        /**
         * Flag if the field is iterable
         *
         * @memberOf Parser.parserFieldDefaultOptions
         *
         * @type {boolean}
         */
        iterable: false
    };

    /**
     * Single parser field aka mustache variable.
     * This is a pure data object containing some information about the usage of the
     * mustache variable in the template.
     *
     * @memberOf Parser
     * @namespace Parser.Field
     *
     * @constructor
     * @param {string} name
     * @param {{}} options
     */
    function Field(name, options) {

        /**
         * name of the field
         *
         * @name name
         * @memberOf Parser.Field
         *
         * @type {string}
         */
        this.name = name;

        /**
         * additional options of the field.
         * See {@link parserFieldDefaultOptions} for more information.
         *
         * @name options
         * @memberOf Parser.Field
         *
         * @type {Parser.parserFieldDefaultOptions}
         */
        this.options = extend(true, {}, parserFieldDefaultOptions, options);
    }


    /**
     * Mustache includes are translated to relations between nodes.
     * This is a pure data object containing some information about the include.
     *
     * @memberOf Parser
     * @namespace Parser.Include
     *
     * @constructor
     * @param {string} name
     * @param {{}} info
     */
    function Include(name, info) {

        /**
         * name of the field
         *
         * @name name
         * @memberOf Parser.Include
         *
         * @type {string}
         */
        this.name = name;

        /**
         * Additional information provided by previous comment in template.
         *
         * @name info
         * @memberOf Parser.Include
         *
         * @type {{}}
         */
        this.options = info;
    }

    /**
     * Parser class
     *
     * @fires Parser#error
     * @fires Parser#include
     * @fires Parser#field
     * @fires Parser#end
     * @fires Parser#nodeinfo
     *
     * @memberOf Parser
     * @namespace Parser.Parser
     *
     * @constructor
     * @param {string} file Absolute file path to mustache template
     */
    function Parser(file) {
        events.EventEmitter.call(this);

        /**
         * File path to parse
         *
         * @name file
         * @memberOf Parser.Parser
         *
         * @type {string}
         */
        this.file = file;
    }
    util.inherits(Parser, events.EventEmitter);

    /**
     * Main parsing method.
     * Uses mustache to do the basic parsing. Then walk through the tokens and handle imports and all that.
     *
     * @function parse
     * @memberOf Parser.Parser
     */
    Parser.prototype.parse = function() {
        var $this = this;
        fs.readFile(this.file, function(err, content) {
            if(err) {
                $this.emit('error', err);
                return;
            }

            // parse template with mustache
            var parsed = Mustache.parse(content.toString()),
                lastInfo = null;

            // walk through all the tokens the mustache parser found
            parsed.forEach(function(b) {
                if(b &amp;&amp; b.length > 0) {
                    switch(b[0]) {

                        /**
                         * Handle comments
                         * Comments may contain additional information for imports or the base node
                         */
                        case '!':
                            var value = b[1];
                            switch(true) {
                                case (value.substr(0, 'cr:element'.length) === 'cr:element'):
                                    lastInfo = JSON.parse(value.substr('cr:element'.length + 1));
                                    break;

                                case (value.substr(0, 'cr:node'.length) === 'cr:node'):
                                    var opts = JSON.parse(value.substr('cr:node'.length + 1));
                                    $this.emit('nodeinfo', opts);
                                    break;
                            }
                            break;

                        /**
                         * Handle imports
                         */
                        case '>':
                            // provide basic fallback
                            if(lastInfo === null) {
                                lastInfo = {
                                    name: b[1]
                                };
                            }
                            $this.emit('include', new Include(b[1], lastInfo));
                            lastInfo = null;
                            break;

                        /**
                         * Handle for-loops
                         */
                        case '#':
                            if(lastInfo === null) {
                                lastInfo = {};
                            }
                            var defaultOpts = {
                                iterable: true
                            };
                            var iteraField = new Field(b[1], extend(defaultOpts, lastInfo));
                            $this.emit('field', iteraField);
                            lastInfo = null;
                            break;

                        /**
                         * Handle normal variable fields
                         */
                        case 'name':
                            if(lastInfo === null) {
                                lastInfo =  {};
                            }
                            var field = new Field(b[1], extend({}, lastInfo));
                            $this.emit('field', field);
                            lastInfo = null;
                            break;

                    }
                }
            });

            $this.emit('end');
        });
    };

    module.exports = {
        Parser      : Parser,
        Field       : Field,
        Include     : Include
    };
})(module);</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="Builder.CrNode.html">CrNode</a></li><li><a href="Builder.NodeStorage.html">NodeStorage</a></li><li><a href="Conductor.Conductor.html">Conductor</a></li><li><a href="Parser.Field.html">Field</a></li><li><a href="Parser.Include.html">Include</a></li><li><a href="Parser.Parser.html">Parser</a></li><li><a href="Writer.Writer.html">Writer</a></li></ul><h3>Namespaces</h3><ul><li><a href="Builder.html">Builder</a></li><li><a href="Conductor.html">Conductor</a></li><li><a href="Conductor.defaultOptions.html">defaultOptions</a></li><li><a href="Parser.html">Parser</a></li><li><a href="Parser.parserFieldDefaultOptions.html">parserFieldDefaultOptions</a></li><li><a href="Writer.html">Writer</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha10</a> on Wed Nov 05 2014 23:01:05 GMT+0100 (CET)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
